# üóÇÔ∏è BeatSync „ÇØ„É©„ÇπÂõ≥

## ÂÖ®‰Ωì„ÇØ„É©„ÇπÊßãÈÄ†

```mermaid
classDiagram
    %% UI Layer
    class MainWindow {
        -MainWindowViewModel viewModel
        +InitializeComponent()
        +OnFileDrop(DragEventArgs)
        +OnDragOver(DragEventArgs)
    }

    class MainWindowViewModel {
        -AudioEngine _audioEngine
        -BpmSyncController _bpmSyncController
        -BpmFlashController _flashController
        -SettingsService _settingsService
        
        +int BPM
        +bool IsFileLoaded
        +bool IsPlaying
        +string StatusMessage
        +ObservableCollection~TrackInfoViewModel~ ImportedTracks
        
        +PlayCommand : ICommand
        +StopCommand : ICommand
        +ClearFileCommand : ICommand
        +SaveCurrentBpmCommand : ICommand
        
        +LoadFileAsync(string)
        +Play()
        +Stop()
        +SetParentWindow(Window)
    }

    class FullscreenFlashWindow {
        -MainWindowViewModel _viewModel
        +Show()
        +Hide()
        +OnKeyDown(KeyEventArgs)
    }

    class WaveformControl {
        -WaveformControlViewModel _viewModel
        +UpdateWaveform(float[])
    }

    class WaveformControlViewModel {
        -float[] _waveformData
        +PointCollection Points
        +double DurationSeconds
        +double CurrentPosition
        
        +UpdateWaveform(float[])
        +UpdatePosition(double)
    }

    class TrackInfoViewModel {
        +TrackInfo TrackInfo
        +string FileName
        +string BpmDisplay
        +string FilePath
        +int Bpm
        +string Notes
        
        +LoadCommand : ReactiveCommand
        +RemoveCommand : ReactiveCommand
        
        +RefreshDisplay()
    }

    %% Audio Layer
    class AudioEngine {
        -WaveOutEvent? _waveOut
        -LoopStream? _loopStream
        -string? _currentFilePath
        
        +bool IsPlaying
        +TimeSpan Duration
        +TimeSpan Position
        +float Volume
        
        +event Action~float[]~ WaveformDataAvailable
        +event Action PlaybackStopped
        
        +LoadFile(string) : bool
        +Play()
        +Stop()
        +SetVolume(float)
        +SetStartTime(double)
        +Dispose()
    }

    class LoopStream {
        -WaveStream _sourceStream
        -double _startTimeSeconds
        
        +TimeSpan Length
        +TimeSpan Position
        +WaveFormat WaveFormat
        
        +SetStartTime(double)
        +Read(byte[], int, int) : int
        +Dispose()
    }

    %% Sync Layer
    class BpmSyncController {
        -Timer? _beatTimer
        -DateTime _startTime
        -TimeSpan _beatInterval
        
        +int BPM
        +bool IsRunning
        +int BeatCount
        +double LastBeatTime
        
        +event Action BeatDetected
        +event Action~int~ BeatCountChanged
        
        +Start()
        +Stop()
        +GetCurrentDrift() : double
        +Dispose()
    }

    class BpmFlashController {
        -BpmSyncController _syncController
        -MainWindowViewModel _viewModel
        
        +FlashPattern SelectedFlashPattern
        +string BeatCounterText
        
        +event Action~FlashPattern, int~ FlashTriggered
        
        -OnBeatDetected()
        -ApplySingleAreaFlash(int)
        -ApplyFourCirclesFlash(int)
        -ApplyProgressiveBarFlash(int)
    }

    class FlashPattern {
        <<enumeration>>
        SingleArea
        FourCircles
        ProgressiveBar
    }

    %% Services Layer
    class SettingsService {
        -string _settingsPath
        -UserSettings _currentSettings
        
        +GetSettings() : UserSettings
        +SaveSettingsAsync(UserSettings)
        +SaveSettings(UserSettings)
        +LoadSettings()
        +GetTrackInfo(string) : TrackInfo?
        +AddOrUpdateTrack(TrackInfo)
        +RemoveTrack(string)
    }

    %% Data Layer
    class UserSettings {
        +string UserNotes
        +List~TrackInfo~ ImportedTracks
        +DateTime LastUpdateTime
    }

    class TrackInfo {
        +string Id
        +string FileName
        +string FilePath
        +int Bpm
        +string Notes
        +DateTime AddedTime
        +DateTime LastUsedTime
    }

    %% Converters
    class EnumToBoolConverter {
        +Convert(object, Type, object, CultureInfo) : object
        +ConvertBack(object, Type, object, CultureInfo) : object
        +Instance : EnumToBoolConverter
    }

    %% Relationships
    MainWindow --> MainWindowViewModel : uses
    MainWindow --> WaveformControl : contains
    FullscreenFlashWindow --> MainWindowViewModel : references
    
    MainWindowViewModel --> AudioEngine : manages
    MainWindowViewModel --> BpmSyncController : controls
    MainWindowViewModel --> BpmFlashController : uses
    MainWindowViewModel --> SettingsService : uses
    MainWindowViewModel --> TrackInfoViewModel : creates
    MainWindowViewModel --> WaveformControlViewModel : owns
    
    BpmFlashController --> BpmSyncController : listens
    BpmFlashController --> FlashPattern : uses
    BpmFlashController --> MainWindowViewModel : updates
    
    AudioEngine --> LoopStream : creates
    
    SettingsService --> UserSettings : manages
    UserSettings --> TrackInfo : contains
    TrackInfoViewModel --> TrackInfo : wraps
    
    WaveformControl --> WaveformControlViewModel : uses
```

## Ë©≥Á¥∞„ÇØ„É©„ÇπË®≠Ë®à

### 1. UI Layer „ÇØ„É©„Çπ

#### MainWindowViewModel
**ÂΩπÂâ≤**: „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆ„É°„Ç§„É≥„É≠„Ç∏„ÉÉ„ÇØÂà∂Âæ°
**„Éë„Çø„Éº„É≥**: MVVM, Observer, Command

```csharp
public class MainWindowViewModel : ReactiveObject, IDisposable
{
    // Fields
    private AudioEngine _audioEngine;
    private BpmSyncController _bpmSyncController;
    private BpmFlashController _flashController;
    private SettingsService _settingsService;
    
    // Observable Properties
    public int BPM { get; set; }
    public bool IsFileLoaded { get; private set; }
    public bool IsPlaying { get; private set; }
    public string StatusMessage { get; set; }
    public ObservableCollection<TrackInfoViewModel> ImportedTracks { get; }
    
    // Commands
    public ICommand PlayCommand { get; }
    public ICommand StopCommand { get; }
    public ICommand ClearFileCommand { get; }
    public ICommand SaveCurrentBpmCommand { get; }
    
    // Methods
    public async Task LoadFileAsync(string filePath);
    public void Play();
    public void Stop();
}
```

#### TrackInfoViewModel
**ÂΩπÂâ≤**: Ê•ΩÊõ≤ÊÉÖÂ†±„ÅÆË°®Á§∫„Å®„Ç≥„Éû„É≥„ÉâÂá¶ÁêÜ
**„Éë„Çø„Éº„É≥**: MVVM, Command

```csharp
public class TrackInfoViewModel : ReactiveObject
{
    public TrackInfo TrackInfo { get; }
    
    // Computed Properties
    public string FileName => TrackInfo.FileName;
    public string BpmDisplay => $"{TrackInfo.Bpm} BPM";
    public int Bpm => TrackInfo.Bpm;
    
    // Commands
    public ReactiveCommand<Unit, Unit> LoadCommand { get; }
    public ReactiveCommand<Unit, Unit> RemoveCommand { get; }
    
    // Events
    public event Action<TrackInfoViewModel>? LoadRequested;
    public event Action<TrackInfoViewModel>? RemoveRequested;
}
```

### 2. Audio Layer „ÇØ„É©„Çπ

#### AudioEngine
**ÂΩπÂâ≤**: Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„ÉªÂÜçÁîüÂà∂Âæ°
**„Éë„Çø„Éº„É≥**: Factory, Observer

```csharp
public class AudioEngine : IDisposable
{
    private WaveOutEvent? _waveOut;
    private LoopStream? _loopStream;
    
    // Properties
    public bool IsPlaying => _waveOut?.PlaybackState == PlaybackState.Playing;
    public TimeSpan Duration => _loopStream?.Length ?? TimeSpan.Zero;
    public TimeSpan Position => _waveOut?.GetPosition() ?? TimeSpan.Zero;
    
    // Events
    public event Action<float[]>? WaveformDataAvailable;
    public event Action? PlaybackStopped;
    
    // Methods
    public bool LoadFile(string filePath);
    public void Play();
    public void Stop();
    public void SetVolume(float volume);
    public void SetStartTime(double seconds);
}
```

#### LoopStream
**ÂΩπÂâ≤**: ÊåáÂÆöÊôÇÈñì„Åã„Çâ„ÅÆ„É´„Éº„ÉóÂÜçÁîü
**„Éë„Çø„Éº„É≥**: Decorator, Stream

```csharp
public class LoopStream : WaveStream
{
    private readonly WaveStream _sourceStream;
    private double _startTimeSeconds;
    
    // Properties
    public override WaveFormat WaveFormat => _sourceStream.WaveFormat;
    public override long Length => _sourceStream.Length;
    public override long Position { get; set; }
    
    // Methods
    public void SetStartTime(double seconds);
    public override int Read(byte[] buffer, int offset, int count);
}
```

### 3. Sync Layer „ÇØ„É©„Çπ

#### BpmSyncController
**ÂΩπÂâ≤**: È´òÁ≤æÂ∫¶BPMÂêåÊúüÂà∂Âæ°
**„Éë„Çø„Éº„É≥**: Observer, State

```csharp
public class BpmSyncController : IDisposable
{
    private Timer? _beatTimer;
    private DateTime _startTime;
    private TimeSpan _beatInterval;
    
    // Properties
    public int BPM { get; set; }
    public bool IsRunning { get; private set; }
    public int BeatCount { get; private set; }
    
    // Events
    public event Action? BeatDetected;
    public event Action<int>? BeatCountChanged;
    
    // Methods
    public void Start();
    public void Stop();
    public double GetCurrentDrift();
    private void OnTimerElapsed(object? state);
}
```

#### BpmFlashController
**ÂΩπÂâ≤**: „Éï„É©„ÉÉ„Ç∑„É•„Éë„Çø„Éº„É≥„ÅÆÂÆüË°åÂà∂Âæ°
**„Éë„Çø„Éº„É≥**: Strategy, Observer

```csharp
public class BpmFlashController
{
    private readonly BpmSyncController _syncController;
    private readonly MainWindowViewModel _viewModel;
    
    // Properties
    public FlashPattern SelectedFlashPattern { get; set; }
    public string BeatCounterText { get; private set; }
    
    // Events
    public event Action<FlashPattern, int>? FlashTriggered;
    
    // Methods
    private void OnBeatDetected();
    private void ApplySingleAreaFlash(int beatNumber);
    private void ApplyFourCirclesFlash(int beatNumber);
    private void ApplyProgressiveBarFlash(int beatNumber);
}
```

### 4. Services Layer „ÇØ„É©„Çπ

#### SettingsService
**ÂΩπÂâ≤**: „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö„Å®„Éá„Éº„Çø„ÅÆÊ∞∏Á∂öÂåñ
**„Éë„Çø„Éº„É≥**: Repository, Singleton

```csharp
public class SettingsService
{
    private const string SettingsFileName = "beatsync_settings.json";
    private readonly string _settingsPath;
    private UserSettings _currentSettings;
    
    // Methods
    public UserSettings GetSettings();
    public async Task SaveSettingsAsync(UserSettings settings);
    public void SaveSettings(UserSettings settings);
    public void LoadSettings();
    public TrackInfo? GetTrackInfo(string filePath);
    public void AddOrUpdateTrack(TrackInfo trackInfo);
    public void RemoveTrack(string filePath);
}
```

### 5. Data Layer „ÇØ„É©„Çπ

#### UserSettings
**ÂΩπÂâ≤**: „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö„Éá„Éº„Çø„ÅÆÊßãÈÄ†ÂÆöÁæ©
**„Éë„Çø„Éº„É≥**: Data Transfer Object

```csharp
public class UserSettings
{
    [JsonPropertyName("userNotes")]
    public string UserNotes { get; set; } = string.Empty;
    
    [JsonPropertyName("importedTracks")]
    public List<TrackInfo> ImportedTracks { get; set; } = new();
    
    [JsonPropertyName("lastUpdateTime")]
    public DateTime LastUpdateTime { get; set; }
}
```

#### TrackInfo
**ÂΩπÂâ≤**: Ê•ΩÊõ≤ÊÉÖÂ†±„Éá„Éº„Çø„ÅÆÊßãÈÄ†ÂÆöÁæ©
**„Éë„Çø„Éº„É≥**: Data Transfer Object

```csharp
public class TrackInfo
{
    [JsonPropertyName("id")]
    public string Id { get; set; } = string.Empty;
    
    [JsonPropertyName("fileName")]
    public string FileName { get; set; } = string.Empty;
    
    [JsonPropertyName("filePath")]
    public string FilePath { get; set; } = string.Empty;
    
    [JsonPropertyName("bpm")]
    public int Bpm { get; set; } = 120;
    
    [JsonPropertyName("notes")]
    public string Notes { get; set; } = string.Empty;
    
    [JsonPropertyName("addedTime")]
    public DateTime AddedTime { get; set; }
    
    [JsonPropertyName("lastUsedTime")]
    public DateTime LastUsedTime { get; set; }
}
```

## „ÇØ„É©„ÇπÈñìÁõ∏‰∫í‰ΩúÁî®

### ‰æùÂ≠òÈñ¢‰øÇ„Ç∞„É©„Éï
```
MainWindowViewModel
    ‚îú‚îÄ‚îÄ AudioEngine
    ‚îÇ   ‚îî‚îÄ‚îÄ LoopStream
    ‚îú‚îÄ‚îÄ BpmSyncController
    ‚îú‚îÄ‚îÄ BpmFlashController
    ‚îÇ   ‚îú‚îÄ‚îÄ BpmSyncController (ÂèÇÁÖß)
    ‚îÇ   ‚îî‚îÄ‚îÄ FlashPattern
    ‚îú‚îÄ‚îÄ SettingsService
    ‚îÇ   ‚îî‚îÄ‚îÄ UserSettings
    ‚îÇ       ‚îî‚îÄ‚îÄ TrackInfo
    ‚îú‚îÄ‚îÄ TrackInfoViewModel
    ‚îÇ   ‚îî‚îÄ‚îÄ TrackInfo (ÂèÇÁÖß)
    ‚îî‚îÄ‚îÄ WaveformControlViewModel
```

### „Ç§„Éô„É≥„Éà„Éï„É≠„Éº
```
BpmSyncController.BeatDetected
    ‚Üì
BpmFlashController.OnBeatDetected
    ‚Üì
MainWindowViewModel UIÊõ¥Êñ∞
```

### „Éá„Éº„Çø„Éï„É≠„Éº
```
„É¶„Éº„Ç∂„ÉºÊìç‰Ωú
    ‚Üì
MainWindowViewModel
    ‚Üì
SettingsService
    ‚Üì
UserSettings (JSONÊ∞∏Á∂öÂåñ)
```

## Ë®≠Ë®à„Éë„Çø„Éº„É≥„ÅÆÈÅ©Áî®

### 1. MVVM Pattern
- **View**: XAML „Éï„Ç°„Ç§„É´
- **ViewModel**: MainWindowViewModel, TrackInfoViewModel
- **Model**: UserSettings, TrackInfo

### 2. Observer Pattern
- **Subject**: BpmSyncController, AudioEngine
- **Observer**: BpmFlashController, MainWindowViewModel

### 3. Command Pattern
- **Command**: ReactiveCommand
- **Invoker**: UIË¶ÅÁ¥†ÔºàButtonÁ≠âÔºâ
- **Receiver**: ViewModel „É°„ÇΩ„ÉÉ„Éâ

### 4. Factory Pattern
- **Factory**: AudioEngine (WaveStreamÁîüÊàê)
- **Product**: ÂêÑÁ®ÆWaveStream„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà

### 5. Repository Pattern
- **Repository**: SettingsService
- **Entity**: UserSettings, TrackInfo
- **Data Source**: JSON „Éï„Ç°„Ç§„É´

### 6. Strategy Pattern
- **Strategy**: FlashPattern enum
- **Context**: BpmFlashController
- **Concrete Strategy**: ÂêÑ„Éï„É©„ÉÉ„Ç∑„É•ÂÆüË£Ö„É°„ÇΩ„ÉÉ„Éâ

## „ÇØ„É©„ÇπÊã°Âºµ„Ç¨„Ç§„Éâ„É©„Ç§„É≥

### Êñ∞„Åó„ÅÑ„Éï„É©„ÉÉ„Ç∑„É•„Éë„Çø„Éº„É≥ËøΩÂä†
1. `FlashPattern` enum„Å´Êñ∞„Åó„ÅÑÂÄ§„ÇíËøΩÂä†
2. `BpmFlashController`„Å´ÂØæÂøú„Åô„Çã„É°„ÇΩ„ÉÉ„Éâ„ÇíËøΩÂä†
3. UI„Å´ÈÅ∏Êäû„Éú„Çø„É≥„ÇíËøΩÂä†

### Êñ∞„Åó„ÅÑÈü≥Â£∞„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÂØæÂøú
1. `AudioEngine.LoadFile`„Å´„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÂà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØËøΩÂä†
2. ÂøÖË¶Å„Å´Âøú„Åò„Å¶Êñ∞„Åó„ÅÑStream„ÇØ„É©„Çπ‰ΩúÊàê
3. „Éï„Ç°„Ç§„É´„Éï„Ç£„É´„Çø„Éº„ÇíÊõ¥Êñ∞

### Êñ∞„Åó„ÅÑUIÊ©üËÉΩËøΩÂä†
1. ÂØæÂøú„Åô„ÇãViewModel„Éó„É≠„Éë„ÉÜ„Ç£ËøΩÂä†
2. ReactiveCommand„ÅÆÂÆüË£Ö
3. XAML„Åß„ÅÆ„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞Ë®≠ÂÆö

---

„Åì„ÅÆ„ÇØ„É©„ÇπÂõ≥„ÅØ„ÄÅBeatSync„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂÖ®‰ΩìÁöÑ„Å™„ÇØ„É©„ÇπÊßãÈÄ†„Å®Áõ∏‰∫íÈñ¢‰øÇ„ÇíÁ§∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÊñ∞„Åó„ÅÑÈñãÁô∫ËÄÖ„Åå„Ç≥„Éº„Éâ„Éô„Éº„Çπ„ÇíÁêÜËß£„Åó„ÄÅÈÅ©Âàá„Å™Êã°Âºµ„ÇíË°å„ÅÜÈöõ„ÅÆÂèÇËÄÉ„Å®„Åó„Å¶Ê¥ªÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ